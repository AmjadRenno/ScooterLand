@page "/opretordre"
@using Radzen  <!-- Importer Radzen -->
@using Radzen.Blazor
@using BlazorAppClientServer.Client.Services
@using BlazorAppClientServer.Shared.Models
@using System.Net;
@inject HttpClient HttpClient


<h3>Create a New Order</h3>

<div>
    <label>Customer Name:</label>
    <input type="text" @bind="selectedKunde" />
</div>

<div>
    <label>Select Product:</label>
    <select @bind="SelectedProductId">
        <option value="" disabled>Select a product</option>
        @foreach (var ydelse in YdelseList)
        {
            <option value="@ydelse.YdelseId">@ydelse.Navn (@ydelse.Pris:C)</option>
        }
    </select>
    <label>Quantity:</label>
    <input type="number" @bind="SelectedQuantity" min="1" />

    <button @onclick="AddProduct">Add to List</button>
</div>

<h4>Products in Order:</h4>
@if (OrderYdelser.Any())
{
    <ul>
        @foreach (var product in OrderYdelser)
        {
            <li>@product.ProductName - Quantity: @product.Quantity</li>
        }
    </ul>
}
else
{
    <p>No products added yet.</p>
}

<button @onclick="SubmitOrder">Submit Order</button>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <p style="color: red;">@ErrorMessage</p>
}

@code {
    [Inject]
    private IOrdreService OrdreService { get; set; }

    [Inject]
    private IYdelseService YdelseService { get; set; }

    [Inject]
    private IKundeService KundeService { get; set; }

    private string selectedKunde = "";
    private int SelectedProductId;
    private int SelectedQuantity = 1;
    private List<Ydelse> YdelseList = new();
    private List<Kunde> KundeList = new();
    private List<OrderProductDisplay> OrderYdelser = new();
    private string ErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load products from the API
            YdelseList = (await YdelseService.GetAllYdelser()).ToList();
            KundeList = (await KundeService.GetAllKunder()).ToList();
        }
        catch (Exception ex)
        {
            ErrorMessage = "Failed to load products: " + ex.Message;
        }
    }

    private void AddProduct()
    {
        var ydelse = YdelseList.FirstOrDefault(p => p.YdelseId == SelectedProductId);
        if (ydelse != null)
        {
            // Add product to the list
            OrderYdelser.Add(new OrderProductDisplay
                {
                    YdelseId = ydelse.YdelseId,
                    ProductName = ydelse.Navn,
                    Pris = ydelse.Pris,
                    Art = ydelse.Art,
                    Timer = ydelse.Timer,
                    Quantity = SelectedQuantity
                });

            // Reset the form
            SelectedProductId = 0;
            SelectedQuantity = 1;
        }
    }

    private async Task SubmitOrder()
    {
        try
        {
            var request = new CreateOrderRequest
                {
                    KundeId = KundeList.Single(k => k.Navn == selectedKunde).KundeId,
                    MekanikerId = 1,
                    Ydelser = OrderYdelser.Select(p => new YdelseItem
                    {
                        YdelseId = p.YdelseId,
                        Quantity = p.Quantity
                    }).ToList()
                };
            Ordre addedOrdre = new Ordre { OrdreDate = DateTime.Now, Status = false, MekanikerId = request.MekanikerId, YdelseItems = request.Ydelser };
            var response = await OrdreService.AddOrdre(addedOrdre);

            if (response == (int)HttpStatusCode.OK)
            {
            }
            else
            {
                ErrorMessage = "Failed to create order.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Failed to submit order: " + ex.Message;
        }
    }

    private class OrderProductDisplay
    {
        public int YdelseId { get; set; }
        public string ProductName { get; set; }
        public double Pris { get; set; }
        public string Art { get; set; }
        public double Timer { get; set; }
        public int Quantity { get; set; }

    }
    public class CreateOrderRequest
    {
        public DateTime OrdreDate { get; set; } = DateTime.Now;
        public bool Status { get; set; } = false;
        public int KundeId { get; set; }
        public int MekanikerId { get; set; }
        public List<YdelseItem> Ydelser { get; set; }
    }

}
